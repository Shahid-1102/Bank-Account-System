<!-- Path: src/app/customer/dashboard/dashboard.html -->
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center my-4">
    <h1>Dashboard</h1>
    <a mat-flat-button color="primary" routerLink="/customer/create-account">
      <mat-icon>add</mat-icon>
      Create New Account
    </a>
  </div>

  <div *ngIf="isLoading" class="d-flex justify-content-center align-items-center mt-5">
    <mat-spinner></mat-spinner>
    <h4 class="ms-3">Loading Your Accounts...</h4>
  </div>

  <div *ngIf="error" class="alert alert-danger mt-3">{{ error }}</div>

  <div *ngIf="!isLoading && !error" class="row">
    <div *ngFor="let account of accounts" class="col-lg-6 col-md-12 mb-4">
      <mat-card class="glass-card">
        <mat-card-header>
          <mat-card-title>{{ account.accountType }} Account</mat-card-title>
          <mat-card-subtitle>
            <span class="badge" [ngClass]="{
              'bg-warning text-dark': account.status === 'PENDING',
              'bg-success': account.status === 'APPROVED',
              'bg-danger': account.status === 'REJECTED'
            }">{{ account.status }}</span>
          </mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <p class="text-muted mb-1">Account Number</p>
          <p class="h5">{{ account.accountNumber }}</p>
          <p class="text-muted mb-1 mt-3">Current Balance</p>
          <h2 class="display-6 fw-bold">{{ account.balance | currency:'INR' }}</h2>
          <p *ngIf="account.status === 'REJECTED'" class="text-danger small mt-2">
            <strong>Reason:</strong> {{ account.adminRemarks }}
          </p>
        </mat-card-content>
        <mat-card-actions *ngIf="account.status === 'APPROVED'">
          <button mat-flat-button color="primary" (click)="openTransactionModal(txModal, 'deposit', account.accountNumber)">Deposit</button>
          <button mat-stroked-button color="primary" (click)="openTransactionModal(txModal, 'withdraw', account.accountNumber)">Withdraw</button>
          <button mat-stroked-button color="accent" (click)="openTransactionModal(txModal, 'transfer', account.accountNumber)">Transfer</button>
          <button mat-button (click)="openMiniStatementModal(miniStatement, account.accountNumber)">Mini Statement</button>
          <a mat-button [routerLink]="['/customer/statement']" [queryParams]="{ accountNumber: account.accountNumber }">
            <mat-icon>picture_as_pdf</mat-icon>
            Generate Statement
          </a>
        </mat-card-actions>
      </mat-card>
    </div>
  </div>
</div>


<!-- Transaction Modal Template -->
<ng-template #txModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title text-capitalize">{{ transactionForm.get('type')?.value }}</h4>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="transactionForm" (ngSubmit)="submitTransaction()">
      <p><strong>From Account:</strong> {{ selectedAccountForTx }}</p>
      <div class="form-floating mb-3">
        <input type="number" class="form-control" id="txAmount" placeholder="Amount" formControlName="amount">
        <label for="txAmount">Amount</label>
      </div>
      <div *ngIf="transactionForm.get('type')?.value === 'transfer'" class="form-floating mb-3">
        <input type="text" class="form-control" id="toAccount" placeholder="Recipient Account" formControlName="toAccountNumber">
        <label for="toAccount">Recipient Account Number</label>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-light" (click)="modal.dismiss()">Cancel</button>
    <button type="button" class="btn btn-primary" (click)="submitTransaction()" [disabled]="transactionForm.invalid">Submit</button>
  </div>
</ng-template>

<!-- Mini Statement Modal Template -->
<ng-template #miniStatement let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Mini Statement for {{ selectedAccountForTx }}</h4>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <table class="table table-sm table-striped">
      <thead><tr><th>Date</th><th>Description</th><th>Type</th><th>Amount</th><th>Balance After</th></tr></thead>
      <tbody>
        <tr *ngFor="let tx of miniStatementData">
          <td *ngIf="tx.error" colspan="5" class="text-danger text-center">{{ tx.error }}</td>
          <ng-container *ngIf="!tx.error">
            <td>{{ tx.timestamp | date:'short' }}</td>
            <td>{{ tx.description }}</td>
            <td>{{ tx.transactionType }}</td>
            <td [ngClass]="tx.transactionType === 'DEPOSIT' ? 'text-success' : 'text-danger'">
              {{ tx.amount | currency:'INR' }}
            </td>
            <td>{{ tx.balanceAfter | currency:'INR' }}</td>
          </ng-container>
        </tr>
        <tr *ngIf="miniStatementData.length === 0">
          <td colspan="5" class="text-center">No recent transactions found.</td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-light" (click)="modal.dismiss()">Close</button>
  </div>
</ng-template>